# cvs_postgres_structure
Хранение изменений структуры БД PostgreSQL

## Хранение логов изменений структуры БД в таблицах БД PostgreSQL
В папке csv_for_db находятся SQL-скрипты, которые необходимо выполнить в БД PostgreSQL

- **pg_proc_history.sql** - Создает таблицу public.pg_proc_history для хранения Функций БД
- **pg_proc_history_sync.sql** - Создание функции public.pg_proc_history_sync() которая при запуске анализирует различия с 
более ранними версиями и добавляет в таблицу public.pg_proc_history изменившиеся записи
- **pg_views_history.sql** - Создает таблицу public.pg_views_history для хранения Представлений (Views)
- **pg_views_history_sync.sql** - Создание функции public.pg_views_history_sync() которая при запуске анализирует различия с 
более ранними версиями и добавляет в таблицу public.pg_views_history изменившиеся записи

### Основные поля таблиц:
- **uid** - уникальный идентификатор в пределах таблицы
- **create_date** - Дата сохранения изменений (по умолчанию ставит время выполнения синхронизации)

### Другие поля таблиц:  
#### pg_proc_history:
- **code** - Код содержащий: Имя схемы, Имя функции, Параметры функции с типами
- **addnew** - Признак вновь добавленной функции которой ранее не было
- **deleted** - Признак удаления функции
- **sql_create** - SQL создания функции
- **prorettype_name** - Возвращаемый тип
- **prolang_name** - Язык функции
- **prodescription** - Комментарий к функции
- **pronamespace_name** - Имя схемы
- **proname** - Имя функции
- **prosrc** - Тело функции

#### pg_views_history:
- **code** - Код содержащий: Имя схемы, Имя представления.
- **addnew** - Признак вновь добавленного представления View которой ранее не было
- **deleted** - Признак удаления Представления
- **sql_create** - SQL создания Представления
-  **schemaname** - Имя схемы
-  **viewname** - Имя Представления
-  **definition** - Тело Представления

После создания таблиц и функций, можно по крону настроить запуск функций 
```
SELECT public.pg_proc_history_sync(); 
SELECT public.pg_views_history_sync();
```  
После чего уже можно использовать сравнение версий.

## Хранение изменений структуры БД в Git или других репозитариях
В папке csv_for_git находится скрипт создания файлов структуры БД:
- csv_pg_git.py - Основной скрипт
- csv_pg_git_config.py.sample - файл необходимо скопировать/переименовать в файл csv_pg_git_config.py и отредактировать 
его в соответствии со своими настройками БД. Есть возможность настроить наименования папок.

После запуска Основного скрипта (csv_pg_git.py) должна сформироваться структура папок где в соответствии с 
настройками будут расположены файлы с текстом структур БД (Функции, Представления, Структуры таблиц, Внешние таблицы)